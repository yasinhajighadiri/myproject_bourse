import sqlite3
import datetime
import re
import requests
from bs4 import BeautifulSoup


all_id=[10024128313803797, 10114441830266109, 10119316306180846, 10120557300120078, 10145129193828624, 10171945867136336, 10264703848556348, 10568944722570445, 10795723506538053, 10928048683681643, 11129387075131725, 11258722998911897, 11273669187884551, 11372565594192822, 11403770140000603, 11427939669935844, 114312662654155, 11432067920374603, 11622051128546106, 11773403764702778, 11827297444577200, 11964419322927535, 12004613727363965, 12089903491411130, 12329519546621752, 12387472624849835, 12390706505809150, 12490072956930435, 12638840758449459, 12746730665870442, 12752224677923341, 12872237992812035, 12874072841236826, 12913156843322499, 12950089213578221, 13137618157831630, 13159807909493237, 13227300125161435, 13235547361447092, 13243992182070788, 13281937213456378, 13308788562230031, 1358190916156744, 13611044044646901, 13613810595093800, 13666407494621646, 13937270451301973, 14027767200567014, 14231831499205396, 14312030900097668, 1438514795814416, 14617104402836487, 14744445176220774, 14916489896692147, 14925348052932291, 14957056743925737, 15039949673085566, 15253567808512995, 15259343650667588, 15320166500344623, 15451317146134956, 15472396110662150, 15494954332657697, 15521712617204216, 15606994155942913, 15726796686853780, 15868116507376197, 15875798076889154, 15917865009187760, 15949743338644220, 16040900750729921, 16056283141617755, 16164451491521441, 1625149423498289, 16369313804633525, 16382005745854279, 16405556680571453, 16406868012951979, 16410724132711490, 16422980660132735, 16693610252404739, 16959429956899455, 16984771612846489, 17059960254855208, 17166179154270422, 17185906359043494, 17226661368470120, 17271591847303499, 17294004769739915, 17330546482145553, 17350417307140851, 17489918101053443, 17528249960294496, 17617474823279712, 1775538989481366, 1778142796834142, 17800036702302776, 17834623106317041, 17841559345136415, 17939384202383793, 18004480270695404, 18007109712724189, 18027801615184692, 18063426072758458, 18093681647131179, 1822787329898392, 18303237082155264, 18401147983387689, 18568733593280948, 18568915061663137, 18599703143458101, 18756929178329039, 18865325633315847, 18883380772506226, 19040514831923530, 19106496156354497, 19257295292088310, 19298748452450329, 19348717261145458, 19471788163911687, 1971414714671246, 20024911381434086, 2034260331120693, 20364630378954250, 204092872752957, 20411759370751096, 20453828618330936, 20487994977117557, 20560887114747719, 20562694899904339, 20582209779850866, 20865316761157979, 20909901812271390, 20926459161497908, 20946530370469828, 21432551703060846, 2147129961448440, 21487763692496856, 2161110547458064, 21739827748084069, 21772258644715569, 21809651793872657, 22086876724551482, 22087269603540841, 22255783119783047, 22260326095996531, 22275596386264204, 22299894048845903, 22382156782768756, 22490169030401337, 2254054929817435, 22560050433388046, 22651353502910749, 22667016906590506, 22787503301679573, 22811176775480091, 22839330962768817, 22903901709044823, 22941065011246116, 23086515493897579, 23214828924506640, 23257748575526845, 2328862017676109, 23293437377896568, 23353689102956991, 23441366113375722, 23600798892801694, 23837844039713715, 23838634016123354, 23936607891892333, 2400322364771558, 24007790892919316, 24079409192818584, 24085906177899789, 24254843881948059, 24303422207378456, 24371538373380305, 24626774281986185, 24644999329120295, 24708628740891857, 24785665268004766, 24812639884028453, 24854455175613815, 24869832924911721, 25001509088465005, 25044429813354280, 25180702353416009, 25215182208950217, 25244329144808274, 25247997049920089, 25286509736208688, 25336820825905643, 25357135030606405, 25435625417909263, 25514780181345713, 25521205614022015, 25531248086533033, 25559236668122210, 2574713500861668, 25821711388846518, 2589887561569709, 26014913469567886, 26052804412414513, 26259366519412975, 26547785441834730, 26622634572348721, 26824673819862694, 26997316501080743, 27000326841257664, 27096851668435724, 27148595522452496, 27218386411183410, 27308217070238237, 27405735172634593, 27814844870305607, 2783314456414734, 27922860956133067, 27971147929780521, 28033133021443774, 28249406393740313, 28253678449273505, 28291104595448527, 28320293733348826, 28325731560106431, 28328710198554144, 28431095903407567, 28450080638096732, 28533890681853700, 28642980400739326, 28651877626222725, 28672095850798501, 28683929595428153, 28788598290160782, 28809886765682162, 28864540805361867, 28930554685672419, 28957320033282870, 29075808594290931, 29122854902865456, 29247915161590165, 29353641328443647, 2944500421562364, 29590002988360984, 29747059672582491, 29758477602878557, 29816505887910059, 29860265627578401, 29882244560576007, 29884261753438378, 29920507291109104, 29974853866926823, 3019817952865782, 30231789123900526, 30282299500988269, 30447901674051381, 30547172156682975, 30650426998863332, 30703140537034664, 30719054967088301, 30765727085936322, 30799980755729585, 30829203706095076, 30833222394217136, 30974710508383145, 31024260997481994, 31078457170311964, 31366347648583654, 3149396562827132, 31529165012057847, 31791737198597563, 31879190587976736, 31913287805282551, 32051979696170482, 32071281098735478, 32257753560585502, 3229565978761118, 32347247706508046, 32357363984168442, 32403934717719219, 32525655729432562, 32678431934327184, 32679348534913643, 32784604551756178, 32821908911812078, 32845891587040106, 33254899395816171, 33293588228706998, 33406621820337161, 33407851615887009, 33420285433308219, 33441514568901717, 33541897671561960, 33603212156438463, 33611155027418901, 33629260529503413, 3364804725289013, 33683240001985963, 3370493881245014, 33783140337377394, 33808206014018431, 33854964748757477, 33887145736684266, 33931218652865616, 33999993357686605, 34032872653290886, 34072858270659593, 3407806799514469, 34144395039913458, 34281064670365091, 34557241988629814, 34641719089573667, 34673681828119297, 34718633636164421, 34890845654517313, 3492952121304423, 3493306453706327, 34968127278627996, 35158826900216508, 35178706978554988, 35282121039020302, 35366681030756042, 35424116338766901, 35425587644337450, 35669480110084448, 35700344742885862, 3577388800305243, 35774045108521927, 35796086458096255, 35911567789826625, 35948133957468680, 35964395659427029, 36055481782812079, 3622735179834649, 3623921205367364, 36263817190995463, 36273975537785965, 3654864906585643, 36592972482259020, 36773155987365094, 36857080203588624, 36899214178084525, 37016155512293915, 37148101999680137, 37204371816016200, 37222720235819361, 37281199178613855, 37284308569715577, 37389789764168256, 37614886280396031, 37631109616997982, 37661500521100963, 37842793167868642, 38084304113529336, 3823243780502959, 3826561665587230, 38285971158073841, 38379938776552696, 38436612777305077, 38437201078089290, 3846143218462419, 38473429161988929, 38555056423456635, 38568786927478796, 3863538898378476, 38713440086361985, 39063197125156374, 39116664428676213, 39329349079135923, 39453972158399542, 39610074039667804, 39644291165016483, 39751275523025334, 39807886630843041, 39884565732277052, 40004156358768554, 40118769556907353, 40262275031537922, 40348118513018291, 40411537531154482, 40505767672724777, 40611478183231802, 40808043719554948, 408934423224097, 40907790180697910, 41048299027409941, 41069781197349728, 41122066907413786, 41227201752535311, 41284516796232939, 41286608288791633, 41302553376174581, 41625340598198551, 41781090739318251, 41796741644273824, 41807682439655536, 41935584690956944, 41974758296041288, 42031056662310763, 42075223783409640, 42255763746648766, 42354736493447489, 42387718866026650, 4247709727327181, 42599305106713939, 42688128362500386, 42690477960659940, 42858674052906172, 43062880954780884, 4312836939310355, 43256212620530446, 43319345548600453, 43342306308122676, 43362635835198978, 43424104797750893, 43443105991896600, 43455612336353491, 43501047082635150, 43531447361624437, 43545527030854340, 43552974795606067, 43622578471330344, 4369934250728330, 43700005955291201, 43716452378323683, 43781018754867729, 4384288570322406, 43966385447049549, 44013656953678055, 44153164692325703, 44495929981585411, 44549439964296944, 44625249840480397, 4470657233334072, 44818950263583523, 44850033148208596, 44891482026867833, 44922289455815256, 44967158778304588, 44973596387994711, 45050389997905274, 4507558419857064, 45174198424472334, 45205530868811305, 4528607775462304, 45353549301778828, 45392752356003555, 45507655586782998, 45518744711972166, 45519261544951819, 4563413583000719, 45728383369147894, 45736528102248622, 45747858932368314, 45895339414786358, 45928267225042656, 4614779520007780, 46158168563513286, 46178280540110577, 46348559193224090, 46700660505281786, 46741025610365786, 46752599569017089, 46773487536596471, 46784744534299861, 46982154647719707, 47077325533515854, 47101579271117172, 47232550823972469, 47302318535715632, 4733285133017464, 47333458678352378, 47348197320716810, 47377315952751604, 4758266259250794, 47656761093772146, 47749661205825616, 47996917271187218, 48010225447410247, 48020123520149025, 48043180063638654, 48241092863917835, 48287670503317419, 48511238766369097, 48619517949257749, 48753732042176709, 48771123304040433, 48879205486884942, 48990026850202503, 4901886287361309, 49054891736433700, 49188729526980541, 49353447565507376, 4942127026063388, 49502666250908008, 49531369050649247, 49572366276578291, 49856142659693686, 50002340308486819, 50100062518826135, 50139638026536387, 50185721305191887, 50247622569476338, 50341528161302545, 5054819322815158, 50627185818815003, 50633804639547462, 50689220001642146, 50792786683910016, 51106317433079213, 51185499879934793, 51200575796028449, 51498801962232097, 51538663270850079, 51617145873056483, 5181039426047414, 5187018329202415, 51971068201094874, 52011547716040734, 5203880991539408, 52220424531578944, 52232388263291380, 52382684379473036, 52650855448517413, 52699075188861283, 52792903131341205, 52975109254504632, 5305844922895340, 53113471126689455, 5317427172344706, 53204330224889981, 53251602435454519, 53254637903825194, 53295835881618508, 53419976284977130, 53449700212786324, 53722792570471890, 5375835669418897, 53841229888975788, 53855930777434169, 53892173815383358, 53999651992586159, 54277068923045214, 5427792638736934, 54327068307120961, 54350501495743633, 54419429862704331, 54482686501491508, 54493234408301135, 54676885047867737, 55063374774131788, 55127657985997520, 55254206302462116, 55344005108664033, 55373808401388162, 5547896159175454, 55530995590147831, 55606320662360341, 5564768007356822, 55850912428859273, 55897939403232751, 55916539620839777, 55924039170758349, 5599691633622269, 56156728102902031, 56312333937384814, 56324206651661881, 56394387537858740, 56550776668133562, 56820995669577571, 56881993417852599, 57086055330734195, 57093249173439707, 57179403661425745, 57273529732791251, 57300230097485720, 57309221039930244, 57376264268853589, 57551382352708199, 57639364758870873, 57675016001659793, 57722642338781674, 57728534324022361, 57761388729898548, 57875847776839336, 57944184894703821, 57945047632313684, 58450346768466421, 58642948567107444, 5866848234665627, 58741071099161284, 58873907630765023, 58931793851445922, 58964593134314938, 59142194115401696, 59217041815333317, 59266699437480384, 59462881877083131, 59486059679335017, 59598536122397373, 59607545337891226, 59612098290740355, 59816244739292046, 59866041653103343, 5987841496184505, 59921975187856916, 60247433951600827, 60270441595112355, 60344745752588969, 60350996279289099, 60430727210956800, 6043384171800349, 60451823714332895, 60610861509165508, 60654872678917533, 61024703979802025, 6110133418282108, 61102694810476197, 61138375569132052, 6116572045021585, 61170189647376533, 611986653700161, 61265100181977543, 6131290133202745, 61332057061846617, 61469668095573716, 61506294208022391, 61506473958237003, 6183017539978894, 62012736978844991, 62163307327505842, 62177651435283872, 62235397452612911, 62258804563636993, 62346804681275278, 62404730109947970, 62558926998470335, 62603302940123327, 62786156501584862, 62952165421099192, 62977319271289925, 63108831364455693, 63363116407864462, 63380098535169030, 63395132075359459, 63481599728522324, 63580313877463104, 63830424809501048, 63915926161403347, 63917421733088077, 64147416931510702, 64217006537761390, 64298008532791199, 64341992373049080, 64358061873294912, 64619251116188373, 64699417405634265, 64701620739344512, 6478064539164167, 64843936383937546, 64942549055019553, 64973252728260903, 65004959184388996, 65018804181564924, 65023851436340574, 65122215875355555, 65249046611427924, 65321970913593427, 65414507129586385, 655060129740445, 65576885779918210, 65658464061006386, 65671173927025645, 65672821991747405, 65676208671737936, 65769010525958483, 65774725600261203, 65820006714554872, 65883838195688438, 65913670626064922, 65985619452718369, 65999092673039059, 66036975502302203, 66065991340922139, 66142616039907394, 66155644912694585, 66295665969375744, 66315581735594751, 66450490505950110, 66456062140680461, 66599109405217136, 66682662312253625, 66701874099226162, 66726992874614788, 66772024744156373, 66818022341772870, 66824711724213057, 67030488744129337, 67118789076485253, 67126881188552864, 67170215467608124, 67173340430154589, 67206358287598044, 67327029014085707, 67478671296584496, 67522512921942106, 6757220448540984, 67675656072510693, 67690708346979840, 67744724115735698, 67988012428906654, 68117765376081366, 68203878405672734, 68250192165442911, 68285083509815728, 68318131776429593, 68404094821755424, 68458335399886534, 6847536925606808, 68488673556087148, 68517032834363488, 68635710163497089, 68693425159484949, 68890878790107680, 68909035712962732, 68939583331837015, 68941822863885255, 68946560981333509, 69065132449283302, 69067576215760005, 69090868458637360, 69127380152328925, 69143674941561637, 69399924050316081, 69446612239102459, 69454539056549106, 69464030305121322, 69723868583662174, 69847139870135237, 69882333653254165, 6998731525091228, 70219663893822560, 70270965300262393, 70289374539527245, 70474983732269112, 70498485598181604, 70595828753641750, 70884918776822518, 70934270174405743, 71068313834275501, 71076372178147339, 71176600083256560, 71285829584745492, 71510396252618330, 71516048161401340, 71523986304961239, 71672399601682259, 71744682148776880, 71758511001096824, 7183333492448248, 71856634742001725, 7198535347763801, 7235435095059069, 7300125658580126, 7395271748414592, 7411928504522115, 7457232989848872, 7483280423474368, 7589585714770259, 7628308021169118, 7711282667602555, 7715968593254705, 7745894403636165, 778253364357513, 7863570390410066, 8078103750560921, 85752389012333, 8646067353086740, 8725363201030474, 8905255747609110, 8915450910866216, 8977369674477111, 8977441217024425, 917857106093847, 9211775239375291, 9481703061634967, 9499505005317710, 9528405732912087, 9536587154100457, 9698674686691945, 9882348775152461]

def get_page(url):
    try:
        response = requests.get(url)
    except:
        return None

    return response




def find_links_per_page(html_doc):
    soup = BeautifulSoup(html_doc, 'html.parser')
    return soup.select('#form1 > script:nth-child(2)')


'''
link = 'http://tsetmc.com/Loader.aspx?ParTree=15'
response_page = get_page(link)
links = find_links(response_page.text)
'''

def creat_all_links_list(idlist):
    all_links_list=[]
    all_links_list_data=[]
    for id in idlist:
        all_links_list.append(f'http://tsetmc.com/Loader.aspx?ParTree=151311&i={id}')
        all_links_list_data.append(f'http://tsetmc.com/tsev2/data/instinfofast.aspx?i={id}&c=23%20')
    return all_links_list,all_links_list_data



con = sqlite3.connect('bourse.db')
cur = con.cursor()


cur.execute('''CREATE TABLE data(
                InstrumentID text,
                InsCode text,
                LVal18AFC text,
                Title text)''')


all_links_list=creat_all_links_list(all_id)

for li in all_links_list[0]:
    try:
        response=get_page(li)
        links=find_links_per_page(response.text)
        InstrumentID=re.search("InstrumentID='(.+)',Ins", str(links)).group(1)
        InsCode=re.search("InsCode=\'(.+)\',Base", str(links)).group(1)
        LVal18AFC=re.search("LVal18AFC='(.+)\',DEve", str(links)).group(1)
        Title=re.search("Title=\'(.+) \(.+-.+\',Fara", str(links)).group(1)
        tess="""INSERT INTO data (InstrumentID,InsCode,LVal18AFC,Title) VALUES (?,?,?,?);"""
        data=(InstrumentID,InsCode,LVal18AFC,Title)
        cur.execute(tess,data)
    except:
        pass


# Insert a row of data

for row in con.execute("select * from data"):
    print(row)
# Save (commit) the changes
con.commit()
